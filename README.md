# Stateless Replica Monitor

Docker Compose ã¨ Nginx ã‚’æ´»ç”¨ã—ãŸã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ãªãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã®è² è·åˆ†æ•£ï¼ˆãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ï¼‰ãŠã‚ˆã³é«˜å¯ç”¨æ€§æ§‹æˆã‚’å­¦ç¿’ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚

## ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€å˜ä¸€ã®å…¥ã‚Šå£ï¼ˆNginxï¼‰ã‹ã‚‰è¤‡æ•°ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆBun/Elysiaï¼‰ã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åˆ†æ•£ã•ã›ã‚‹ã€ŒStatelessã€ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚ã©ã®ã‚³ãƒ³ãƒ†ãƒŠãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã—ã¦ã‚‚ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã¯ä¸€è²«ã—ãŸä½“é¨“ãŒæä¾›ã•ã‚Œã¾ã™ã€‚

### ä¸»ãªå­¦ç¿’ãƒˆãƒ”ãƒƒã‚¯

* **Docker Compose ã«ãŠã‘ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°**: `--scale` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹è¤‡æ•°ã‚³ãƒ³ãƒ†ãƒŠã®ç®¡ç†ã€‚
* **Nginx ã«ã‚ˆã‚‹ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã¨ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°**: `upstream` ã®å‹•çš„ãªåå‰è§£æ±ºã€‚
* **Docker å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã® DNS ä»•æ§˜**: åŸ‹ã‚è¾¼ã¿ DNS ã‚µãƒ¼ãƒãƒ¼ (`127.0.0.11`) ã®å½¹å‰²ã€‚
* **SSL çµ‚ç«¯**: ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã® `mkcert` ã‚’åˆ©ç”¨ã—ãŸ HTTPS åŒ–ã€‚

---

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

```mermaid
graph LR
    User((User Browser)) -->|HTTPS| NgrokCloud(ngrok Cloud)
    
    subgraph "Docker Bridge Network"
        NgrokContainer[ngrok Container]
        Nginx{Nginx Proxy}
        App1(App Replica 1)
        App2(App Replica 2)
        App3(App Replica 3)
    end

    NgrokCloud -->|Tunnel| NgrokContainer
    NgrokContainer -->|HTTP/HTTPS| Nginx
    Nginx -->|Round Robin| App1
    Nginx -->|Round Robin| App2
    Nginx -->|Round Robin| App3
```

---

## ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨å®Ÿè¡Œ

### 1. æº–å‚™ (SSL & Build)

ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ã®ä¿¡é ¼ã•ã‚ŒãŸè¨¼æ˜æ›¸ã‚’ç”Ÿæˆã—ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚

```bash
make ssl
cd application && bun run build.ts && cd ..
```

### 2. èµ·å‹•

`make up` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ 3 å°ã®ãƒ¬ãƒ—ãƒªã‚«æ§‹æˆã§èµ·å‹•ã—ã¾ã™ã€‚

```bash
make up
```

*(å†…éƒ¨å®Ÿè¡Œ: `docker compose up -d --build --scale application=3`)*

### 3. åœæ­¢ãƒ»å‰Šé™¤

```bash
make down
```

---

## ğŸ” å‹•ä½œç¢ºèªã®æ–¹æ³•

### ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã®æ¤œè¨¼

Nginx ã¯ Docker ã®å†…éƒ¨ DNS ã‚’å‚ç…§ã—ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å„ã‚³ãƒ³ãƒ†ãƒŠã«æŒ¯ã‚Šåˆ†ã‘ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’é€£ç¶šã§å®Ÿè¡Œã—ã€`container_id` ãŒå¤‰åŒ–ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```bash
export APP_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')

# 5å›é€£ç¶šã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
for i in {1..5}; do curl -k $APP_URL/api/whoami; echo ""; done
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ä¾‹:**

```json
{"message":"Hello from the cluster!","hostname":"2be726f1bd46","ip":"172.20.0.3","time":"2026-02-07T11:08:32.235Z"}
{"message":"Hello from the cluster!","hostname":"2bae0f1ac116","ip":"172.20.0.4","time":"2026-02-07T11:08:32.320Z"}
{"message":"Hello from the cluster!","hostname":"3a4b89cd3dda","ip":"172.20.0.5","time":"2026-02-07T11:08:32.486Z"}
{"message":"Hello from the cluster!","hostname":"2be726f1bd46","ip":"172.20.0.3","time":"2026-02-07T11:08:32.591Z"}
{"message":"Hello from the cluster!","hostname":"2bae0f1ac116","ip":"172.20.0.4","time":"2026-02-07T11:08:32.682Z"}
```

---

## ğŸ› ï¸ æŠ€è¡“çš„ç‰¹è¨˜äº‹é …

### Nginx ã® DNS resolver è¨­å®š

Docker ã®ã‚µãƒ¼ãƒ“ã‚¹åã¯å‹•çš„ã« IP ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ãŸã‚ã€Nginx ã®èµ·å‹•æ™‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹å·¥å¤«ã‚’ã—ã¦ã„ã¾ã™ã€‚

* **Resolver æŒ‡å®š**: `resolver 127.0.0.11 valid=1s;` ã‚’è¨­å®šã—ã€Docker ã®åŸ‹ã‚è¾¼ã¿ DNS ã‚’å¼·åˆ¶çš„ã«å‚ç…§ã€‚
* **å‹•çš„ãƒ—ãƒ­ã‚­ã‚·**: `proxy_pass` ã«å¤‰æ•°ï¼ˆä¾‹: `$target_api`ï¼‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«åå‰è§£æ±ºã‚’å®Ÿè¡Œã€‚

### Docker Swarm vs Compose

* **Compose**: ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã«é©ã—ã¦ãŠã‚Šã€`build` ã‚„ `volumes` ã®ç›¸å¯¾ãƒ‘ã‚¹ã€`platform` æŒ‡å®šãŒæŸ”è»Ÿã€‚
* **Swarm**: æœ¬ç•ªé‹ç”¨ã«é©ã—ã¦ã„ã‚‹ãŒã€`build` æŒ‡å®šãŒç„¡è¦–ã•ã‚Œã‚‹ã€`container_name` ãŒä½¿ç”¨ä¸å¯ã€ç›¸å¯¾ãƒ‘ã‚¹ã®ãƒã‚¦ãƒ³ãƒˆãŒåˆ¶é™ã•ã‚Œã‚‹ç­‰ã®åˆ¶ç´„ãŒã‚ã‚‹ã€‚
*â€»æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® `make deploy` ã¯ Swarm ãƒ¢ãƒ¼ãƒ‰ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è©¦è¡Œã—ã¾ã™ã€‚*

---

## ğŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

* `application/`: Bun (Elysia.js) & React ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
* `nginx/`: Nginx è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŠã‚ˆã³ Dockerfile
* `tools/`: è¨¼æ˜æ›¸ç”Ÿæˆã€mkcert å°å…¥ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
* `compose.yml`: ãƒãƒ«ãƒã‚³ãƒ³ãƒ†ãƒŠã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾©
* `Makefile`: é‹ç”¨ã‚³ãƒãƒ³ãƒ‰ã®é›†ç´„

---
